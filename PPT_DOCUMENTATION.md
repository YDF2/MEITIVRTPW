# 外卖配送路径优化系统 - PPT演示文档

## 🎯 项目主题

**基于自适应大邻域搜索(ALNS)的外卖配送路径优化系统**

---

# 第一部分：问题背景与定义

## 1.1 实际业务背景

### 外卖配送场景
- **参与主体**：配送站(Depot)、商家(Pickup)、顾客(Delivery)、骑手(Rider)
- **业务流程**：骑手从配送站出发 → 到商家取餐 → 送达顾客 → 继续下一单
- **核心挑战**：如何在时间约束下，用最少的骑手完成最多的订单，同时最小化总配送距离

### 问题规模
| 参数 | 典型值 | 物理意义 |
|------|--------|----------|
| 配送区域 | 100×100单位 = 10km×10km | 覆盖城市核心商圈 |
| 时间跨度 | 300分钟 | 午高峰4-5小时 |
| 订单数量 | 20-500 | 单站点单时段订单量 |
| 骑手数量 | 5-100 | 站点可调度骑手数 |

---

## 1.2 问题数学建模：PDPTW

### 问题定义
**PDPTW = Pickup and Delivery Problem with Time Windows（带时间窗的取送货问题）**

这是经典VRP问题的扩展变体，属于**NP-Hard**问题。

### 数学符号定义

| 符号 | 含义 | 说明 |
|------|------|------|
| $G = (V, E)$ | 图结构 | $V$=节点集, $E$=边集 |
| $V = D \cup P \cup Q$ | 节点集 | $D$=配送站, $P$=取货点, $Q$=送货点 |
| $K$ | 骑手集合 | 每个骑手$k$有容量$C_k$ |
| $O$ | 订单集合 | 每个订单$o=(p_o, q_o, d_o)$ |
| $[e_i, l_i]$ | 时间窗 | $e_i$=最早服务时间, $l_i$=最晚服务时间 |
| $s_i$ | 服务时间 | 在节点$i$的停留时间 |
| $t_{ij}$ | 行驶时间 | 从节点$i$到$j$的时间 |

### 决策变量

$$
x_{ijk} = 
\begin{cases}
1, & \text{若骑手}k\text{从节点}i\text{直接前往节点}j \\
0, & \text{否则}
\end{cases}
$$

$$
a_i = \text{骑手到达节点}i\text{的时间}
$$

### 目标函数

$$
\min Z = w_1 \cdot \sum_{k \in K} \sum_{(i,j) \in E} d_{ij} \cdot x_{ijk} + w_2 \cdot \sum_{i \in V} T_i^{delay} + w_3 \cdot |U| \cdot M + w_4 \cdot |K_{used}|
$$

**目标函数组成**：
| 分量 | 符号 | 权重 | 物理意义 |
|------|------|------|----------|
| 总行驶距离 | $\sum d_{ij}$ | $w_1=1.0$ | 骑手骑行成本 |
| 超时惩罚 | $\sum T_i^{delay}$ | $w_2=10.0$ | 顾客满意度损失 |
| 未分配惩罚 | $|U| \cdot M$ | $w_3=10000$ | 绝对不允许甩单 |
| 骑手使用成本 | $|K_{used}|$ | $w_4=100$ | 人力成本 |

---

## 1.3 约束条件

### 🔴 硬约束（必须满足）

#### 1. 配对约束 (Pairing Constraint)
$$
\forall o \in O: \sum_{k \in K} y_{p_o,k} = \sum_{k \in K} y_{q_o,k} = 1
$$
**物理意义**：每个订单的取货点和送货点必须由**同一骑手**服务

#### 2. 顺序约束 (Precedence Constraint)
$$
\forall o \in O: a_{p_o} + s_{p_o} + t_{p_o, q_o} \leq a_{q_o}
$$
**物理意义**：必须**先取货再送货**，骑手必须先到商家拿餐才能送给顾客

#### 3. 容量约束 (Capacity Constraint)
$$
\forall k \in K, \forall i \in route_k: \sum_{j \leq i} d_j \leq C_k
$$
**物理意义**：骑手携带的餐品数量不能超过**最大载重**（通常3-6单）

#### 4. 节点访问唯一性
$$
\forall i \in P \cup Q: \sum_{k \in K} \sum_{j \in V} x_{ijk} = 1
$$
**物理意义**：每个取货点/送货点**只能被访问一次**

### 🟡 软约束（可违反但有惩罚）

#### 5. 时间窗约束 (Time Window Constraint)
$$
e_i \leq a_i \leq l_i + T_{max}^{delay}
$$
**物理意义**：骑手应在时间窗内到达，但允许一定程度的**迟到**（软时间窗）

超时惩罚公式：
$$
T_i^{delay} = \max(0, a_i - l_i)
$$

---

## 1.4 物理参数设计

### 距离与时间模型

| 参数 | 值 | 物理意义 | 来源 |
|------|-----|----------|------|
| 坐标单位 | 1 unit = 100m | 便于计算 | 设计选择 |
| 曼哈顿距离 | $d(i,j) = |x_i-x_j| + |y_i-y_j|$ | 城市路网近似 | 实际路况 |
| 路阻系数 | $\gamma = 1.3$ | 红绿灯、转弯、拥堵 | 美团数据 |
| 骑手速度 | 3.3 units/min ≈ 20km/h | 电动车实际均速 | 行业经验 |

### 服务时间模型

| 节点类型 | 服务时间 | 物理意义 |
|----------|----------|----------|
| 取货点 | 12分钟 | 停车 → 进店 → 等餐 → 取餐 |
| 送货点 | 30分钟 | 停车 → 进楼 → 等电梯 → 送达 |

### 时间窗设计

| 参数 | 值 | 说明 |
|------|-----|------|
| 时间窗宽度 | 45分钟 | 允许的服务时间范围 |
| 取货时间窗 | [出餐时间, 出餐时间+45] | 商家准备好后45分钟内取走 |
| 送货时间窗 | [最早可达时间, 最早可达+45] | 基于取货后行驶时间计算 |

---

# 第二部分：算法设计

## 2.1 ALNS算法框架

### 什么是ALNS？
**Adaptive Large Neighborhood Search（自适应大邻域搜索）**

核心思想：通过**破坏-修复**框架迭代优化解

```
┌─────────────────────────────────────────────────────────┐
│                    ALNS 主循环                          │
├─────────────────────────────────────────────────────────┤
│  1. 生成初始解 (贪婪插入)                               │
│  2. While (未达到终止条件):                             │
│     │                                                   │
│     ├─ 2.1 选择破坏算子 (UCB策略)                       │
│     ├─ 2.2 选择修复算子 (UCB策略)                       │
│     │                                                   │
│     ├─ 2.3 破坏: 移除若干订单                           │
│     ├─ 2.4 修复: 重新插入订单                           │
│     │                                                   │
│     ├─ 2.5 评估新解成本                                 │
│     ├─ 2.6 模拟退火接受准则                             │
│     │                                                   │
│     ├─ 2.7 更新算子权重                                 │
│     └─ 2.8 降温                                         │
│                                                         │
│  3. 返回最优解                                          │
└─────────────────────────────────────────────────────────┘
```

---

## 2.2 破坏算子 (Destroy Operators)

### 设计理念
破坏算子负责从当前解中**移除部分订单**，为修复算子创造优化空间。

### 六大破坏算子

| 算子 | 策略 | 适用场景 |
|------|------|----------|
| **Random Removal** | 随机移除N个订单 | 全局探索，避免陷入局部最优 |
| **Worst Removal** | 移除"贡献最差"的订单 | 移除后成本降低最多的订单 |
| **Shaw Removal** | 移除相关性高的订单 | 距离近、时间相似的订单组 |
| **Route Removal** | 移除整条路径的订单 | 重新优化单个骑手的路径 |
| **Spatial Proximity** | 移除地理位置接近的订单 | 优化特定区域的配送 |
| **Deadline-based** | 移除时间最紧迫的订单 | 处理时间窗约束冲突 |

### Shaw Removal 相关性计算

$$
Relatedness(o_1, o_2) = \frac{1}{\alpha \cdot D_{norm} + \beta \cdot T_{norm} + \epsilon}
$$

其中：
- $D_{norm} = \frac{d(p_1, p_2) + d(q_1, q_2)}{2 \cdot D_{max}}$ （归一化距离）
- $T_{norm} = \frac{|t_1 - t_2|}{T_{horizon}}$ （归一化时间差）
- $\alpha = \beta = 0.5$ （等权重）

---

## 2.3 修复算子 (Repair Operators)

### 设计理念
修复算子负责将移除的订单**重新插入**解中，寻找最佳插入位置。

### 四大修复算子

| 算子 | 策略 | 特点 |
|------|------|------|
| **Greedy Insertion** | 按最小成本增加插入 | 快速，贪心 |
| **Regret-2 Insertion** | 优先插入后悔值大的订单 | 平衡贪心与全局 |
| **Regret-3 Insertion** | 考虑前3个最佳位置的后悔值 | 更强的全局视野 |
| **Random Insertion** | 随机选择可行位置插入 | 增加多样性 |

### Regret-k 核心公式

$$
Regret_k(o) = Cost_k(o) - Cost_1(o)
$$

**物理意义**：如果现在不把订单插入最佳位置，未来可能付出多大代价

**决策规则**：优先插入 $Regret_k$ 值最大的订单

---

## 2.4 算子自适应选择：UCB机制

### Upper Confidence Bound (UCB) 算法

$$
Score_i = \bar{X}_i + C \cdot \sqrt{\frac{2 \ln N}{n_i}}
$$

| 参数 | 含义 |
|------|------|
| $\bar{X}_i$ | 算子 $i$ 的平均奖励（利用项） |
| $N$ | 总迭代次数 |
| $n_i$ | 算子 $i$ 被使用的次数 |
| $C$ | 探索系数（默认2.0） |

### 奖励机制

| 事件 | 奖励值 | 说明 |
|------|--------|------|
| 找到新全局最优 | $\sigma_1 = 33$ | 最高奖励 |
| 比当前解更好 | $\sigma_2 = 9$ | 中等奖励 |
| 接受了差解 | $\sigma_3 = 13$ | 鼓励探索 |

---

## 2.5 模拟退火接受准则

### 接受概率

$$
P(accept) = 
\begin{cases}
1, & \text{if } \Delta < 0 \text{ (新解更好)} \\
e^{-\Delta / T}, & \text{if } \Delta \geq 0 \text{ (新解更差)}
\end{cases}
$$

其中：$\Delta = Cost_{new} - Cost_{current}$

### 自适应温度初始化

$$
T_0 = \frac{-\tau \cdot Cost_{initial}}{\ln(0.5)}
$$

| 问题规模 | $\tau$ 值 | 初始接受概率 |
|----------|-----------|--------------|
| ≤20 订单 | 0.08 | ~50% 接受差解 |
| 21-50 订单 | 0.06 | ~50% |
| 51-100 订单 | 0.05 | ~50% |
| >100 订单 | 0.04 | ~50% |

### 自适应冷却率

$$
T_{new} = \alpha \cdot T_{old}
$$

| 问题规模 | 冷却率 $\alpha$ | 说明 |
|----------|-----------------|------|
| ≤20 订单 | 0.995 | 快速冷却 |
| 21-50 订单 | 0.9975 | 标准冷却 |
| 51-100 订单 | 0.998 | 较慢冷却 |
| >100 订单 | 0.999 | 慢速冷却（更多探索） |

---

# 第三部分：核心优化技术

## 3.1 Matching Degree Score（匹配度评分）

### 设计灵感
来源于**美团技术论文**，评估订单插入的"风险度"

### 公式定义

$$
MDS = \alpha \cdot Cost + \beta \cdot Risk
$$

### 风险度计算

$$
Risk = \frac{1}{1 + Slack}
$$

其中 **Slack（时间余量）**：
$$
Slack = l_i - (a_i + s_i)
$$

| 参数 | 含义 |
|------|------|
| $l_i$ | 时间窗截止时间 |
| $a_i$ | 到达时间 |
| $s_i$ | 服务时间 |
| $Slack$ | 剩余缓冲时间 |

**物理意义**：Slack越小，订单越"紧张"，风险越高

---

## 3.2 空间邻近性筛选（Spatial Proximity Filtering）

### 问题分析
- 原始方法：为每个订单遍历**所有骑手**寻找最佳插入位置
- 时间复杂度：$O(|K| \cdot n^2)$，其中 $|K|$ 为骑手数，$n$ 为路径长度

### 优化策略
> **不让城市东边的骑手去尝试插入城市西边的订单**

1. 计算订单的中心位置
2. 计算每个骑手当前位置到订单中心的距离
3. 只选择**最近的K个骑手**作为候选

### 动态候选数量

| 骑手总数 | 候选数量 | 比例 |
|----------|----------|------|
| ≤10 | 全部考虑 | 100% |
| 11-30 | max(8, 50%) | 50% |
| 31-50 | max(10, 40%) | 40% |
| >50 | max(10, 30%) | 30% |

### 距离阈值
$$
D_{threshold} = 0.6 \times GridSize
$$

超过此距离的骑手**直接跳过**

---

## 3.3 快速增量评估（Fast Incremental Evaluation）

### 传统方法问题
每次评估插入成本需要：
1. 深拷贝骑手对象
2. 模拟插入
3. 重新计算完整路径成本
4. 恢复原状态

时间复杂度：$O(n)$ 每次评估

### 优化方法：$O(1)$ 增量计算

#### 距离增量公式

插入取货点 $p$ 到位置 $i$：
$$
\Delta d_p = d(prev_i, p) + d(p, next_i) - d(prev_i, next_i)
$$

插入送货点 $q$ 到位置 $j$：
$$
\Delta d_q = d(prev_j, q) + d(q, next_j) - d(prev_j, next_j)
$$

总距离增量：
$$
\Delta d_{total} = \Delta d_p + \Delta d_q
$$

### 两阶段评估策略

```
阶段1: 快速筛选
├── 只计算距离增量 O(1)
├── 快速容量检查
├── 快速时间窗估算
└── 保留 Top-K 候选

阶段2: 精确验证
├── 对 Top-K 候选进行完整评估
├── 检查所有约束
└── 返回真正最优的插入位置
```

---

## 3.4 分治策略（Divide and Conquer）

### 适用场景
订单数 > 100 的大规模问题

### 算法流程

```
┌─────────────────────────────────────────────────────────┐
│              分治求解流程                               │
├─────────────────────────────────────────────────────────┤
│  步骤1: K-Means 聚类                                    │
│         ├── 根据取货点坐标聚类                          │
│         └── 自动确定聚类数 k                            │
│                                                         │
│  步骤2: 分配骑手到各簇                                  │
│         ├── 按订单比例分配                              │
│         └── 确保每簇至少2个骑手                         │
│                                                         │
│  步骤3: 多进程并行求解                                  │
│         ├── 每个簇独立运行ALNS                          │
│         └── 自动调整迭代次数                            │
│                                                         │
│  步骤4: 合并子解                                        │
│         └── 恢复完整solution结构                        │
│                                                         │
│  步骤5: 全局优化                                        │
│         ├── 处理边界效应                                │
│         └── 【关键】保护输入解质量                      │
└─────────────────────────────────────────────────────────┘
```

### 聚类数量自动确定

$$
k = \min\left( \left\lceil \frac{n_{orders}}{50} \right\rceil, \left\lfloor \frac{n_{vehicles}}{10} \right\rfloor \right)
$$

限制范围：$k \in [2, 20]$

---

# 第四部分：模型假设与简化

## 4.1 关于配送网络的假设

| 假设 | 说明 | 合理性 |
|------|------|--------|
| **多站点架构** | 5个固定配送站 | 符合实际城市配送布局 |
| **开放式VRP** | 骑手不返回起点 | 符合外卖骑手实际工作模式 |
| **曼哈顿距离** | 城市路网近似 | 对网格状街道合理 |
| **固定路阻系数** | 统一使用1.3 | 简化时变交通影响 |

## 4.2 关于时间的假设

| 假设 | 说明 | 合理性 |
|------|------|--------|
| **确定性时间** | 行驶时间可精确计算 | 简化实际不确定性 |
| **软时间窗** | 允许迟到但有惩罚 | 符合外卖容忍度 |
| **固定服务时间** | 取餐12分钟，送餐30分钟 | 取平均值简化 |

## 4.3 关于订单的假设

| 假设 | 说明 | 合理性 |
|------|------|--------|
| **订单已知** | 所有订单提前已知 | 适用于批量调度场景 |
| **配送距离限制** | 顾客距商家≤5km | 符合外卖平台政策 |
| **单位货物** | 货物量为1-3单位 | 简化真实餐品差异 |

## 4.4 简化因素

| 简化项 | 影响 | 未来改进方向 |
|--------|------|--------------|
| 忽略等待时间成本 | 骑手等餐时间未计入 | 加入等待成本项 |
| 忽略动态订单 | 无法处理实时新订单 | 扩展为动态PDPTW |
| 忽略骑手疲劳 | 未考虑工作时长限制 | 加入工时约束 |
| 统一车速 | 未考虑道路差异 | 引入路段速度模型 |

---

# 第五部分：项目创新点

## 5.1 算法层面创新

### ✨ 创新1：自适应参数机制
- **初始温度自适应**：根据问题规模动态计算 $T_0$
- **冷却率自适应**：小问题快冷却，大问题慢冷却
- **候选数量自适应**：根据骑手数量调整筛选比例

### ✨ 创新2：UCB算子选择
- 用**强化学习思想**平衡探索与利用
- 自动学习哪些算子对当前问题更有效
- 避免人工调参

### ✨ 创新3：Matching Degree Score
- 引入**风险度**概念评估插入质量
- 不仅考虑成本，还考虑时间裕度
- 提高解的鲁棒性

### ✨ 创新4：空间剪枝优化
- 利用**空间局部性**减少无效计算
- 候选骑手筛选降低时间复杂度
- 对大规模问题效果显著

## 5.2 工程层面创新

### ✨ 创新5：分治并行策略
- K-Means聚类 + 多进程并行
- 全局优化保护机制
- 处理100+订单的大规模问题

### ✨ 创新6：快速增量评估
- $O(1)$ 距离增量计算
- 两阶段筛选策略
- 减少90%+的无效评估

## 5.3 建模层面创新

### ✨ 创新7：多站点开放式VRP
- 5站点对称布局
- 开放式路径（骑手不返回）
- 更符合实际外卖场景

### ✨ 创新8：软时间窗机制
- 时间窗可违反但有惩罚
- 惩罚权重可调
- 平衡服务质量与成本

---

# 第六部分：实验结果

## 6.1 性能对比

| 算法 | 30订单成本 | 50订单成本 | 100订单成本 |
|------|------------|------------|-------------|
| ALNS | 2707.55 | 4500+ | 8000+ |
| ALNS-DC | 1948.77 | 3200+ | 6000+ |
| 改进比例 | **28%** | **29%** | **25%** |

## 6.2 收敛曲线特征

健康的ALNS收敛曲线应具有三个阶段：
1. **快速下降期**（0-200迭代）：高温，快速探索
2. **震荡寻优期**（200-600迭代）：中温，跳出局部最优
3. **平稳收敛期**（600-1000迭代）：低温，精细化

## 6.3 算子使用统计

典型运行中的算子使用分布：
- Shaw Removal: 30-35%
- Worst Removal: 20-25%
- Regret-2 Insertion: 40-45%

---

# 第七部分：代码架构

## 7.1 目录结构

```
MEITIVRTPW/
├── config.py              # 全局配置参数
├── main.py                # 主入口
├── models/                # 数据模型
│   ├── node.py           # 节点、订单模型
│   ├── vehicle.py        # 骑手模型
│   └── solution.py       # 解模型
├── algorithm/             # 算法实现
│   ├── alns.py           # ALNS主算法
│   ├── operators.py      # 破坏/修复算子
│   ├── objective.py      # 目标函数
│   ├── greedy.py         # 贪婪算法
│   └── divide_and_conquer.py  # 分治策略
└── utils/                 # 工具类
    ├── generator.py      # 数据生成
    ├── visualizer.py     # 可视化
    └── file_io.py        # 文件读写
```

## 7.2 核心类关系

```
Solution
├── vehicles: List[Vehicle]
│   └── route: List[Node]
├── orders: Dict[id, Order]
│   ├── pickup_node: Node
│   └── delivery_node: Node
└── depot: Node

ALNS
├── destroy_ops: DestroyOperators
├── repair_ops: RepairOperators
├── objective: ObjectiveFunction
└── solve(solution) → Solution
```

---

# 附录：参数速查表

## 问题参数

| 参数 | 默认值 | 说明 |
|------|--------|------|
| GRID_SIZE | 100 | 10km×10km区域 |
| TIME_HORIZON | 300 | 5小时时间跨度 |
| VEHICLE_CAPACITY | 6 | 骑手最大载重 |
| VEHICLE_SPEED | 3.3 | ~20km/h |
| DETOUR_FACTOR | 1.3 | 路阻系数 |

## 目标函数权重

| 参数 | 默认值 | 说明 |
|------|--------|------|
| WEIGHT_DISTANCE | 1.0 | 距离成本权重 |
| WEIGHT_TIME_PENALTY | 10.0 | 超时惩罚权重 |
| WEIGHT_UNASSIGNED | 10000.0 | 未分配惩罚 |
| WEIGHT_VEHICLE_USAGE | 100.0 | 骑手使用成本 |

## ALNS参数

| 参数 | 默认值 | 说明 |
|------|--------|------|
| MAX_ITERATIONS | 1000 | 最大迭代次数 |
| COOLING_RATE | 0.9975 | 冷却系数 |
| DESTROY_RATE_MIN | 0.1 | 最小破坏比例 |
| DESTROY_RATE_MAX | 0.4 | 最大破坏比例 |
| SIGMA_1 | 33 | 新全局最优奖励 |
| SIGMA_2 | 9 | 更好解奖励 |
| SIGMA_3 | 13 | 接受差解奖励 |

---

# 结语

本项目实现了一个**完整的外卖配送路径优化系统**，具有以下特点：

1. **理论基础扎实**：基于PDPTW经典模型，约束完整
2. **算法设计合理**：ALNS框架 + 多种优化技术
3. **工程实现高效**：并行分治、增量评估、空间剪枝
4. **创新点突出**：自适应参数、UCB选择、匹配度评分
5. **可扩展性强**：模块化设计，易于添加新算子和约束

---

*文档版本：v1.0*  
*最后更新：2024年*
